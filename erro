async def run_input_intent_agent_server(input):
    import uuid
    import logging
    from langgraph.graph import StateGraph, END
    from agents.input_agent import input_agent
    from agents.intent_agent import intent_agent
    from utils.checkpointer import AsyncVegasSaver

    logger = logging.getLogger(__name__)
    logger.setLevel(logging.INFO)

    async with AsyncVegasSaver.execute() as checkpointer:
        try:
            current_session_state = {
                "last_input": "",
                "thread_id": "",
                "dialog": [],
                "messages": []
            }

            # Define the graph
            graph = StateGraph(InputAgentState)

            # Add nodes
            graph.add_node("input", input_agent)
            graph.add_node("intent", intent_agent)

            # Set entry point
            graph.set_entry_point("input")

            # Add conditional logic
            graph.add_conditional_edges(
                "input",
                lambda s: "intent" if s.get("status") == "complete" else END,
                {
                    "intent": "intent",
                    END: END
                }
            )
            graph.add_edge("intent", END)

            # Compile app
            app = graph.compile(checkpointer=checkpointer)
            logger.info("LangGraph app compiled successfully.")

            user_input = input.user_query
            thread_id = input.thread_id.strip() if input.thread_id and input.thread_id.strip() else str(uuid.uuid4())

            if input.thread_id:
                logger.info(f"--- Resuming session (thread_id: {thread_id})")
            else:
                logger.info(f"--- Starting new session (thread_id: {thread_id})")

            current_session_state["last_input"] = user_input
            current_session_state["thread_id"] = thread_id
            current_session_state["messages"].append({"role": "user", "content": user_input})

            try:
                result = await app.ainvoke(current_session_state, config={"configurable": {"thread_id": thread_id}})
                logger.info(f"Execution result: {result}")
                return result
            except Exception as run_error:
                logger.error(f"LangGraph invocation failed: {run_error}", exc_info=True)
                return {
                    "status": "error",
                    "message": str(run_error),
                    "thread_id": thread_id,
                    "dialog": current_session_state.get("dialog", []),
                    "final_problem_statement": [],
                    "next_question": "Something went wrong. Please try again."
                }

        except Exception as e:
            logger.error(f"run_input_intent_agent_server crashed: {e}", exc_info=True)
            return {
                "status": "error",
                "message": str(e),
                "thread_id": "",
                "dialog": [],
                "final_problem_statement": [],
                "next_question": "An unexpected error occurred. Please restart the conversation."
            }
