# Convert messages into plain text history for the LLM
    history_str = "\n".join([f"{m['role']}: {m['content']}" for m in messages[-10:]])  # keep last 10
